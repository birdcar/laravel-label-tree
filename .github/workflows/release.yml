name: Release

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    permissions:
      contents: write

    steps:
      - name: Check for release labels
        id: labels
        env:
          LABELS: ${{ toJson(github.event.pull_request.labels.*.name) }}
        run: |
          if echo "$LABELS" | grep -q "release.breaking"; then
            echo "bump=major" >> $GITHUB_OUTPUT
            echo "Release type: major (breaking)"
          elif echo "$LABELS" | grep -q "release.minor"; then
            echo "bump=minor" >> $GITHUB_OUTPUT
            echo "Release type: minor"
          elif echo "$LABELS" | grep -q "release.patch"; then
            echo "bump=patch" >> $GITHUB_OUTPUT
            echo "Release type: patch"
          else
            echo "bump=none" >> $GITHUB_OUTPUT
            echo "No release label found, skipping release"
          fi

      - name: Exit if no release
        if: steps.labels.outputs.bump == 'none'
        run: echo "No release label, exiting successfully"

      - uses: actions/checkout@v4
        if: steps.labels.outputs.bump != 'none'
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup PHP
        if: steps.labels.outputs.bump != 'none'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'

      - name: Calculate next version
        if: steps.labels.outputs.bump != 'none'
        id: version
        env:
          BUMP_TYPE: ${{ steps.labels.outputs.bump }}
        run: |
          CURRENT=$(jq -r '.version' composer.json)
          echo "Current version: $CURRENT"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "$BUMP_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEXT="${MAJOR}.${MINOR}.${PATCH}"
          echo "Next version: $NEXT"
          echo "version=$NEXT" >> $GITHUB_OUTPUT
          echo "tag=v$NEXT" >> $GITHUB_OUTPUT
          echo "prerelease=$( [ $MAJOR -eq 0 ] && echo true || echo false )" >> $GITHUB_OUTPUT

      - name: Update composer.json version
        if: steps.labels.outputs.bump != 'none'
        env:
          NEW_VERSION: ${{ steps.version.outputs.version }}
        run: |
          jq --arg v "$NEW_VERSION" '.version = $v' composer.json > composer.tmp
          mv composer.tmp composer.json

      - name: Configure git
        if: steps.labels.outputs.bump != 'none'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and tag
        if: steps.labels.outputs.bump != 'none'
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          git add composer.json
          git commit -m "chore: bump version to $VERSION"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin main --follow-tags

      - name: Create GitHub release
        if: steps.labels.outputs.bump != 'none'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.version.outputs.tag }}
          PRERELEASE: ${{ steps.version.outputs.prerelease }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          PRERELEASE_FLAG=""
          if [ "$PRERELEASE" = "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "$TAG" \
            --title "$TAG" \
            --notes "$PR_BODY" \
            $PRERELEASE_FLAG

      - name: Update Packagist
        if: steps.labels.outputs.bump != 'none'
        env:
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_API_TOKEN }}
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            "https://packagist.org/api/update-package?username=birdcar&apiToken=$PACKAGIST_TOKEN" \
            -d '{"repository":{"url":"https://github.com/birdcar/laravel-label-tree"}}'

          echo "Packagist update triggered"
