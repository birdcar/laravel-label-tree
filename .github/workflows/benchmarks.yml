name: Benchmarks

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - db: sqlite
            name: SQLite
          - db: mysql
            name: MySQL 8.4
          - db: pgsql
            name: PostgreSQL 17
          - db: pgsql-ltree
            name: PostgreSQL 17 + ltree

    name: Benchmark (${{ matrix.name }})

    services:
      mysql:
        image: mysql:8.4
        env:
          MYSQL_ROOT_PASSWORD: labeltree
          MYSQL_DATABASE: laravel_label_tree
          MYSQL_USER: labeltree
          MYSQL_PASSWORD: labeltree
        ports:
          - 13306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: labeltree
          POSTGRES_PASSWORD: labeltree
          POSTGRES_DB: laravel_label_tree
        ports:
          - 15432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, pdo_sqlite, pdo_mysql, pdo_pgsql, bcmath
          coverage: none

      - name: Install dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Install ltree extension
        if: matrix.db == 'pgsql-ltree'
        run: |
          PGPASSWORD=labeltree psql -h 127.0.0.1 -p 15432 -U labeltree -d laravel_label_tree -c "CREATE EXTENSION IF NOT EXISTS ltree;"

      - name: Run benchmarks (SQLite)
        if: matrix.db == 'sqlite'
        run: vendor/bin/pest --group=benchmark --compact
        env:
          DB_CONNECTION: testing

      - name: Run benchmarks (MySQL)
        if: matrix.db == 'mysql'
        run: vendor/bin/pest --group=benchmark --compact
        env:
          DB_CONNECTION: mysql

      - name: Run benchmarks (PostgreSQL)
        if: matrix.db == 'pgsql'
        run: vendor/bin/pest --group=benchmark --compact
        env:
          DB_CONNECTION: pgsql

      - name: Run benchmarks (PostgreSQL + ltree)
        if: matrix.db == 'pgsql-ltree'
        run: vendor/bin/pest --group=benchmark --compact
        env:
          DB_CONNECTION: pgsql

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ matrix.db }}
          path: benchmark-results.json
          if-no-files-found: ignore

  update-docs:
    needs: benchmark
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none

      - name: Download all benchmark artifacts
        uses: actions/download-artifact@v4
        with:
          path: benchmark-artifacts
          pattern: benchmark-*

      - name: Generate BENCHMARKS.md
        run: php scripts/generate-benchmark-docs.php

      - name: Commit updated benchmarks
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add docs/BENCHMARKS.md
          git diff --staged --quiet || git commit -m "docs: Update benchmark results for ${TAG_NAME}"
          git push
